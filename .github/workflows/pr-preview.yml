name: PR Preview (Pages, 5-day retention)

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "resume_faangpath.tex"
      - "resume.cls"
      - ".github/workflows/**"

permissions:
  contents: write        # push to gh-pages
  pull-requests: write   # comment URL

env:
  ROOT_TEX: resume_faangpath.tex
  OUT_DIR: build
  SITE_BRANCH: gh-pages

jobs:
  preview:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build PDF (cached)
        uses: xu-cheng/latex-action@v3
        with:
          root_file: ${{ env.ROOT_TEX }}
          latexmk_use_xelatex: true
          work_in_root_file_dir: true
          extra_system_packages: "fontconfig"
          cache: true

      - name: Collect PDF
        run: |
          mkdir -p "$OUT_DIR"
          cp "${ROOT_TEX%.tex}.pdf" "$OUT_DIR/resume.pdf"
          date -u +%Y-%m-%dT%H:%M:%SZ > "$OUT_DIR/.built_at"   # used for cleanup

      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: ${{ env.SITE_BRANCH }}
          path: site
          fetch-depth: 0

      - name: Publish PR preview under /previews/pr-<number>/
        run: |
          PR="pr-${{ github.event.pull_request.number }}"
          DEST="site/previews/$PR"
          mkdir -p "$DEST"
          cp "$OUT_DIR/resume.pdf" "$DEST/resume.pdf"
          cp "$OUT_DIR/.built_at" "$DEST/.built_at"
          # simple viewer
          cat > "$DEST/index.html" <<'HTML'
          <!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
          <title>PR Preview â€” Resume</title>
          <style>body{font-family:system-ui;max-width:860px;margin:40px auto;padding:0 16px}iframe{width:100%;height:900px;border:1px solid #ddd;border-radius:12px}</style>
          <h1>PR Preview â€” Resume</h1>
          <p>This preview will be auto-deleted ~5 days after last build.</p>
          <p><a href="./resume.pdf">Download PDF</a></p>
          <iframe src="./resume.pdf" loading="lazy"></iframe>
          HTML
          cd site
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "PR preview: $PR @ $GITHUB_SHA" || echo "No changes"
          git push origin ${{ env.SITE_BRANCH }}

      - name: Comment PR with preview link
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request.number;
            const url = `https://${context.repo.owner}.github.io/${context.repo.repo}/previews/pr-${pr}/`;
            const body = `### ðŸ“„ Live PR Preview\n- **URL:** ${url}\n- Auto-expires ~5 days after the last preview build.`;
            await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: pr, body });
